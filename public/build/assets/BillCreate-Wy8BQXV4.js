import{r as l,x as ge,w as Ce,m as fe,j as e}from"./index-OeoBNat3.js";import{N as be,Q as Ne}from"./NewCustomerModal-CT3x1Lux.js";import{a as y,c as B}from"./index.esm-BSQayu9G.js";import{f as _}from"./api-8_quPuaU.js";import{c as Se,a as Ae,C as we}from"./CustomProductModal-BsI4c1R2.js";import{u as De,C as Fe}from"./DefaultLayout-B6SAEV22.js";import{C as F}from"./CRow-B0v1wP3B.js";import{C as T}from"./CCol-BhG1DmFz.js";import{C as Te,a as _e}from"./CCardBody-HZcxyyc1.js";import{C as Ie}from"./CCardHeader-D3QUcPyo.js";import{C as Oe}from"./CForm-nOHKzzo5.js";import{C as p}from"./CFormInput-BMIMxTq1.js";import{C as E}from"./cil-mobile-BLiG_LYI.js";import{C as m}from"./CFormLabel-DxfY1rNV.js";import{C}from"./CFormSelect-B3syApAW.js";import{C as ze}from"./CFormCheck-B63ut1Bj.js";import"./CModalTitle-CTXksQDY.js";const Pe=(g,j)=>{let x;return function(...d){clearTimeout(x),x=setTimeout(()=>g(...d),j)}},ke=async(g,j,x)=>{try{const d=await _("/api/searchCustomer?searchQuery="+g);d!=null&&d.length?j(d):j([])}catch(d){x("danger","Error occurred "+d)}},es=()=>{const[g,j]=l.useState(!1),[x,d]=l.useState(!1),[I,R]=l.useState(),[M,f]=l.useState([]),[qe,Q]=l.useState(),[H,O]=l.useState(),[u,z]=l.useState({name:"",mobile:"",address:"",id:null});l.useState(null),l.useState({name:"",size:"",price:0,qty:0});const[V,b]=l.useState(!1),[U,N]=l.useState(!1),[S,J]=l.useState(!1),[A,$]=l.useState(""),[w,L]=l.useState(""),[P,G]=l.useState(""),[o,c]=l.useState({customerName:"",customerId:null,invoiceType:1,invoiceDate:new Date().toISOString().split("T")[0],deliveryDate:new Date().toISOString().split("T")[0],deliveryFor:"",deliveryName:"",deliveryBirthdate:new Date().toISOString().split("T")[0],items:[{product:"",size:"",price:0,qty:1}],relative:[],totalAmount:0,finalAmount:0,balanceAmount:0,discount:0,paidAmount:0,orderStatus:1}),K=s=>{J(s.target.checked)},W=s=>{$(s.target.value)},X=s=>{L(s.target.value)},Y=s=>{G(s.target.value)},{showSpinner:Z,hideSpinner:ee}=ge(),{showToast:D}=Ce(),se=fe(),{t:n}=De("global"),te=Pe(s=>{ke(s,f,D)},750),oe=s=>{const t=s.target.value;z({name:t}),c(i=>({...i,customerName:t})),t?te(t):f([])},ie=s=>{k(s),N(!1)},v=s=>{const{name:t,value:i}=s.target;c(r=>({...r,[t]:i}))};l.useEffect(()=>{ae()},[o.items]),l.useEffect(()=>{ne()},[o.totalAmount,o.discount]),l.useEffect(()=>{re()},[o.billedAmount,o.paidAmount]);const ae=()=>{const s=o.items.reduce((t,i)=>t+i.qty*i.price,0);c(t=>({...t,totalAmount:s}))},ne=()=>{const s=o.totalAmount*o.discount/100,t=o.totalAmount-s;c(i=>({...i,billedAmount:t}))},re=()=>{const s=o.billedAmount-o.paidAmount;c(t=>({...t,balanceAmount:s}))},le=(s,t)=>{if(!o.products)return;const i=o.products.find(a=>a.id===t),r=[...o.items];r[s]={...r[s],product:t,size:"",price:(i==null?void 0:i.price)||0,total:0},c(a=>({...a,items:r}))},ce=(s,t)=>{const i=o.products.find(h=>h.id===o.items[s].product),r=i==null?void 0:i.sizes.find(h=>h.id===t),a=[...o.items];a[s]={...a[s],size:t,price:(r==null?void 0:r.price)||0,total:a[s].qty*((r==null?void 0:r.price)||0)},c(h=>({...h,items:a}))},de=(s,t)=>{const i=[...o.items];i[s]={...i[s],qty:t,total:t*i[s].price},c(r=>({...r,items:i}))},me=()=>{c(s=>({...s,items:[...s.items,{product:"",size:"",price:0,qty:0,total:0}]}))},ue=s=>{const t=o.items.filter((i,r)=>r!==s);c(i=>({...i,items:t}))},he=s=>{let t=0;return s.forEach(i=>{t+=i.total}),t},pe=async s=>{try{const t=await _("/api/customerHistory?id="+s);t&&Q(t)}catch(t){D("danger","Error occured "+t)}},k=s=>{console.log("Selected Suggestion:",s),z(s),console.log("Updated customerName:",s),c(i=>{const r={...i,customerId:s.id};return console.log("Updated State:",r),r});const t=q([...H],s.discount);console.log("Updated Products with Discount:",t),O(t),he(t),f([]),console.log("Suggestions cleared"),pe(s.id),console.log("Fetching customer history for ID:",s.id)},q=(s,t)=>(s.forEach(i=>{i.sizes[0].dPrice=getDiscountedPrice(i,t)}),s),ve=s=>{const t={id:Date.now(),name:s.name,sizes:[{id:Date.now(),name:s.size,price:s.price}]};c(i=>({...i,products:[...i.products,t],items:[...i.items,{product:t.id,size:t.sizes[0].id,price:s.price,qty:s.qty,total:s.price*s.qty}]})),b(!1)},je=async s=>{s.preventDefault();const t=o.invoiceType===1?1:2;console.log("ðŸŸ¢ Form State:",o);const i=S&&w&&A?[{name:w,delivery_for:A,birthdate:P||null}]:[],r={customer_id:o.customerId,total_amount:o.totalAmount,paid_amount:o.paidAmount,balance_amount:o.balanceAmount,order_status:t,discount:o.discount,delivery_date:o.deliveryDate,invoiceDate:o.invoiceDate||null,order_type:o.invoiceType,products:o.items.map(a=>({product_id:a.product,product_size_id:a.size,qty:a.qty,price:a.price})),relatives:i.length>0?i:[]};console.log("ðŸš€ Sending Order Data:",JSON.stringify(r,null,2));try{const a=await fetch("/api/orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(console.log("ðŸŸ¡ Response Status:",a.status),!a.ok)throw new Error(`HTTP error! Status: ${a.status}`);const h=await a.json();console.log("âœ… Order created successfully:",h),h.order&&h.order.id?(console.log("ðŸ”€ Redirecting to Invoice Page..."),se(`/invoice-details/${h.order.id}`)):console.error("âŒ Order ID missing in response!")}catch(a){console.error("âŒ Fetch Error:",a)}},xe=()=>{c({customerName:"",customerId:null,invoiceDate:new Date().toISOString().split("T")[0],items:[{product:"",size:"",price:0,qty:0,total:0}],discount:0,paidAmount:0,balanceAmount:0,billedAmount:0,totalAmount:0,products:[]}),f([]),j(!1),d(!1),R(null)},ye=async()=>{try{Z();const s=await _("/api/product");O(q([...s.filter(i=>i.show==1)]));const t=s.map(i=>({id:i.id,name:i.name,sizes:i.sizes.map(r=>({id:r.id,name:r.size,price:r.oPrice}))}));c(i=>({...i,products:t}))}catch{D("danger","Error fetching products.")}finally{ee()}};return l.useEffect(()=>{ye()},[]),e.jsxs(F,{children:[e.jsx(be,{hint:u.name,onSuccess:ie,visible:U,setVisible:N}),e.jsx(Ne,{visible:x,setVisible:d}),e.jsx(T,{xs:12,children:e.jsxs(Te,{className:"mb-4",children:[e.jsx(Ie,{children:e.jsx("strong",{children:n("invoice.new_invoice")})}),e.jsx(_e,{children:e.jsxs(Oe,{noValidate:!0,validated:g,onSubmit:je,children:[e.jsx("div",{className:"row mb-2",children:e.jsxs("div",{className:"col-9",children:[e.jsx(p,{type:"text",id:"pname",placeholder:n("invoice.customer_name"),name:"customerName",value:u.name,onChange:oe,autoComplete:"off",required:!0}),u.name&&u.name.length>0&&e.jsxs("ul",{className:"suggestions-list",children:[M.map((s,t)=>e.jsxs("li",{onClick:()=>k(s),children:[s.name," (",s.mobile,")"]},t)),!u.id&&e.jsx("li",{children:e.jsx(Fe,{role:"button",color:"danger",onClick:()=>N(!0),children:n("invoice.new_customer")})})]})]})}),u.id&&e.jsx("div",{className:"row",children:e.jsx("div",{className:"col-sm-12 mt-1",children:e.jsx(E,{color:"success",children:e.jsxs("p",{children:[e.jsxs("strong",{children:[n("invoice.name"),":"]})," ",u.name," (",u.mobile,") ",e.jsx("br",{}),u.address&&e.jsxs(e.Fragment,{children:[e.jsxs("strong",{children:[n("invoice.address"),": "]})," ",u.address]})]})})})}),e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(m,{htmlFor:"invoiceType",children:n("invoice.invoice_type")}),e.jsx(C,{"aria-label":n("invoice.select_invoice_type"),name:"invoiceType",value:o.invoiceType,options:[{label:n("invoice.regular"),value:1},{label:n("invoice.advance_booking"),value:2}],onChange:v,required:!0,feedbackInvalid:n("invoice.select_type")})]})}),e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(m,{htmlFor:"invoiceDate",children:n("invoice.invoice_date")}),e.jsx(p,{type:"date",id:"invoiceDate",placeholder:n("invoice.pune"),name:"invoiceDate",value:o.invoiceDate,onChange:v,required:!0,feedbackInvalid:n("invoice.select_date")})]})}),e.jsx("div",{className:"col-sm-4",children:o.invoiceType==2&&e.jsxs("div",{className:"mb-3",children:[e.jsx(m,{htmlFor:"deliveryDate",children:n("invoice.delivery_date")}),e.jsx(p,{type:"date",id:"deliveryDate",placeholder:n("invoice.pune"),name:"deliveryDate",value:o.deliveryDate,onChange:v,required:o.invoiceType==2,feedbackInvalid:n("invoice.select_date")})]})})]}),e.jsx("div",{className:"mb-3",children:e.jsx(ze,{id:"orderForOthers",label:"Delivery For Other",checked:S,onChange:K})}),S&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(m,{htmlFor:"deliveryFor",children:"Delivery For"}),e.jsxs(C,{id:"deliveryFor",value:A,onChange:W,children:[e.jsx("option",{value:"",children:n("invoice.select")}),e.jsx("option",{value:"spouse",children:"Spouse"}),e.jsx("option",{value:"family",children:"Family"}),e.jsx("option",{value:"friend",children:"Friend"})]})]})}),e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(m,{htmlFor:"deliveryName",children:"Name"}),e.jsx(p,{type:"text",id:"deliveryName",name:"deliveryName",value:w,onChange:X,placeholder:n("invoice.enter_name")})]})}),e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(m,{htmlFor:"deliveryBirthdate",children:"Birthdate"}),e.jsx(p,{type:"date",id:"deliveryBirthdate",name:"deliveryBirthdate",value:P,onChange:Y})]})})]})}),e.jsx("div",{className:"table-responsive mb-3",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Product"}),e.jsx("th",{children:"Size"}),e.jsx("th",{children:"Price"}),e.jsx("th",{children:"Qty."}),e.jsx("th",{children:"Action"})]})}),e.jsx("tbody",{children:o.items.length>0&&o.items.map((s,t)=>{const i=Array.isArray(o.products)?o.products.find(a=>a.id===s.product):null,r=i?i.sizes:[];return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs(C,{value:s.product,onChange:a=>le(t,parseInt(a.target.value)),children:[e.jsx("option",{value:"",children:"Select Product"}),Array.isArray(o.products)&&o.products.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})}),e.jsx("td",{children:e.jsxs(C,{value:s.size,onChange:a=>ce(t,parseInt(a.target.value)),disabled:!s.product,children:[e.jsx("option",{value:"",children:"Select Size"}),r.map(a=>e.jsxs("option",{value:a.id,children:[a.name," "]},a.id))]})}),e.jsxs("td",{children:[s.price||"-"," "]}),e.jsx("td",{children:e.jsx(p,{type:"number",value:s.qty,onChange:a=>de(t,parseInt(a.target.value,10))})}),e.jsx("td",{children:e.jsxs("div",{className:"d-flex",children:[o.items.length>1&&e.jsx(y,{color:"danger",onClick:()=>ue(t),children:e.jsx(B,{icon:Se,size:"sm"})}),t===o.items.length-1&&e.jsx(y,{color:"success",onClick:me,children:e.jsx(B,{icon:Ae,size:"sm"})})]})})]},t)})})]})}),e.jsxs("div",{className:"d-flex justify-content-between",style:{marginBottom:"13px"},children:[e.jsx(y,{color:"primary",onClick:()=>b(!0),children:"Customize Order"}),e.jsx(T,{className:"text-end",style:{marginRight:"30px"},children:e.jsxs("h6",{children:["Total: â‚¹",o.totalAmount]})})]}),e.jsx("div",{children:e.jsx(F,{children:e.jsxs(T,{xs:12,md:6,children:[e.jsx(m,{htmlFor:"paymentType",children:n("invoice.payment_type")}),e.jsxs(C,{id:"paymentType",name:"paymentType",value:o.paymentType,onChange:v,children:[e.jsx("option",{value:0,children:n("invoice.cash")}),e.jsx("option",{value:1,children:n("invoice.online")})]})]})})}),e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-sm-2",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(m,{htmlFor:"discount",children:[n("invoice.discount")," (%)"]}),e.jsx(p,{type:"number",id:"discount",placeholder:"0",name:"discount",value:o.discount===0?"":o.discount,onChange:s=>{const t=s.target.value===""?"":Math.max(0,Math.min(100,s.target.value));v({target:{name:"discount",value:t}})}})]})}),e.jsx("div",{className:"col-sm-3",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(m,{htmlFor:"paidAmount",children:[n("invoice.paid_amount")," (Rs)"]}),e.jsx(p,{type:"number",id:"paidAmount",placeholder:"",name:"paidAmount",value:o.paidAmount,onChange:v})]})}),e.jsx("div",{className:"col-sm-3",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(m,{htmlFor:"paidAmount",children:[n("invoice.balance_amount")," (Rs)"]}),e.jsx(p,{type:"number",id:"balanceAmount",placeholder:"",readOnly:!0,name:"balanceAmount",value:o.balanceAmount,onChange:v})]})}),e.jsx("div",{className:"col-sm-2",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(m,{htmlFor:"finalAmount",children:[n("invoice.final_amount")," (Rs)"]}),e.jsx(p,{type:"number",id:"finalAmount",placeholder:"",name:"finalAmount",readOnly:!0,value:o.billedAmount,onChange:v})]})})]}),e.jsx("div",{children:I&&e.jsx(F,{children:e.jsx(E,{color:"danger",children:I})})}),e.jsxs("div",{className:"mb-3 mt-3",children:[e.jsx(y,{color:"success",type:"submit",children:n("invoice.submit")}),"Â ",e.jsx(y,{color:"secondary",onClick:xe,children:n("invoice.clear")}),"Â ",o.paymentType==1&&e.jsx(y,{className:"mr-20",type:"button",onClick:()=>d(!0),color:"primary",children:n("invoice.view_qr")})]})]})})]})}),e.jsx(we,{visible:V,setVisible:b,onAddProduct:ve})]})};export{es as default};
