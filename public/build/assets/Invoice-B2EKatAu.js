import{r as c,x as Se,w as Ae,m as we,j as e}from"./index-CoZNXrT3.js";import{N as De,Q as Fe}from"./NewCustomerModal-BhqB8eUB.js";import{a as j,c as D}from"./index.esm-DG3saitl.js";import{f as P}from"./api-8_quPuaU.js";import{c as J,a as L,C as _e}from"./CustomProductModal-B4Tn99MN.js";import{u as ze,C as Ie}from"./DefaultLayout-BFij5oOH.js";import{C as I}from"./CRow-C1kAJa4E.js";import{C as T}from"./CCol-6gv0qfQb.js";import{C as Te,a as Pe}from"./CCardBody-KiBmAR96.js";import{C as qe}from"./CCardHeader-CzKoGM0V.js";import{C as Oe}from"./CForm-CWuSMnRv.js";import{C as h}from"./CFormInput-D071rTfS.js";import{C as U}from"./cil-mobile-BFL8AfvV.js";import{C as p}from"./CFormLabel-DOuP-TYD.js";import{C as y}from"./CFormSelect-CVgASmge.js";import{C as ke}from"./CFormCheck-QIJdA4HO.js";import"./CModalTitle-yUagMCk3.js";const Be=(b,g)=>{let f;return function(...u){clearTimeout(f),f=setTimeout(()=>b(...u),g)}},Ee=async(b,g,f)=>{try{const u=await P("/api/searchCustomer?searchQuery="+b);u!=null&&u.length?g(u):g([])}catch(u){f("danger","Error occurred "+u)}},nt=()=>{const[b,g]=c.useState(!1),[f,u]=c.useState(!1),[q,$]=c.useState(),[Y,N]=c.useState([]),[Re,G]=c.useState(),[K,O]=c.useState(),[v,F]=c.useState({name:"",mobile:"",address:"",id:null});c.useState(null),c.useState({name:"",size:"",price:0,qty:0});const[W,_]=c.useState(!1),[X,z]=c.useState(!1),[k,Z]=c.useState(!1),[ee,te]=c.useState(""),[se,ne]=c.useState(""),[ae,re]=c.useState(""),[n,m]=c.useState({customerName:"",company_id:null,customerId:null,invoiceType:1,invoiceDate:new Date().toISOString().split("T")[0],deliveryDate:new Date().toISOString().split("T")[0],deliveryFor:"",deliveryName:"",deliveryBirthdate:new Date().toISOString().split("T")[0],items:[{product:"",size:"",price:0,qty:1}],relative:[],totalAmount:0,finalAmount:0,balanceAmount:0,discount:0,paidAmount:0,orderStatus:1,payment_type:0}),oe=t=>{Z(t.target.checked)},ie=t=>{te(t.target.value)},le=t=>{ne(t.target.value)},ce=t=>{re(t.target.value)},{showSpinner:de,hideSpinner:me}=Se(),{showToast:C}=Ae(),ue=we(),{t:i}=ze("global"),he=Be(t=>{Ee(t,N,C)},750),pe=t=>{const s=t.target.value;F({name:s}),m(a=>({...a,customerName:s})),s?he(s):(F({name:"",mobile:"",address:"",id:null}),m(a=>({...a,customerId:null})),N([]))},ve=t=>{Q(t),z(!1)},x=t=>{const{name:s,value:a}=t.target;(s==="invoiceDate"||s==="deliveryDate")&&isNaN(Date.parse(a))||s==="paidAmount"&&a<0||m(o=>({...o,[s]:s==="paidAmount"?a===""?0:parseFloat(a)||0:a}))};c.useEffect(()=>{S()},[n.items]),c.useEffect(()=>{xe()},[n.totalAmount,n.discount]),c.useEffect(()=>{je()},[n.billedAmount,n.paidAmount]);const S=()=>{const t=n.items.reduce((s,a)=>s+(a.total||0),0);console.log("ðŸ”„ Calculated Total:",t),m(s=>({...s,totalAmount:t,finalAmount:t}))},xe=()=>{const t=n.totalAmount*n.discount/100,s=n.totalAmount-t;m(a=>({...a,billedAmount:s}))},je=()=>{const t=n.billedAmount-n.paidAmount;m(s=>({...s,balanceAmount:t}))},B=(t,s)=>{if(!n.products)return;const a=n.products.find(d=>d.id===s),o=[...n.items];o[t]={...o[t],product:s,size:"",price:(a==null?void 0:a.price)||0,total:((a==null?void 0:a.price)||0)*o[t].qty},m(d=>({...d,items:o}),()=>{S()})},E=(t,s)=>{const a=n.products.find(r=>r.id===n.items[t].product),o=a==null?void 0:a.sizes.find(r=>r.id===s),d=[...n.items];d[t]={...d[t],size:s,price:(o==null?void 0:o.price)||0,total:d[t].qty*((o==null?void 0:o.price)||0)},m(r=>({...r,items:d}),()=>{S()})},A=(t,s)=>{const a=[...n.items];a[t]={...a[t],qty:s,total:s*a[t].price},m(o=>({...o,items:a}),()=>{S()})},R=()=>{m(t=>({...t,items:[...t.items,{product:"",size:"",price:0,qty:0,total:0}]}))},M=t=>{const s=n.items.filter((a,o)=>o!==t);m(a=>({...a,items:s}))},ye=t=>{let s=0;return t.forEach(a=>{s+=a.total}),s},ge=async t=>{try{const s=await P("/api/customerHistory?id="+t);s&&G(s)}catch(s){C("danger","Error occured "+s)}},Q=t=>{console.log("Selected Suggestion:",t),F(t),console.log("Updated customerName:",t),m(a=>{const o={...a,customerId:t.id};return console.log("Updated State:",o),o});const s=H([...K],t.discount);console.log("Updated Products with Discount:",s),O(s),ye(s),N([]),console.log("Suggestions cleared"),ge(t.id),console.log("Fetching customer history for ID:",t.id)},H=(t,s)=>(t.forEach(a=>{a.sizes[0].dPrice=getDiscountedPrice(a,s)}),t),fe=t=>{if(!t.name||t.name.trim()===""){alert("Custom product name is required!");return}if(!t.size||t.size.trim()===""){alert("Custom product size is required!");return}const s={id:Date.now(),name:t.name,size:t.size,price:t.price,qty:t.qty};m(a=>{let o=[...a.items];return o.length===1&&!o[0].product?o[0]={...s,product:s.id,total:s.price*s.qty}:o.push({...s,product:s.id,total:s.price*s.qty}),{...a,items:o}}),_(!1)},be=async t=>{t.preventDefault();const s=JSON.parse(localStorage.getItem("userData")),a=s?s==null?void 0:s.user.company_id:null,o=n.invoiceType===1?1:2;if(console.log("Form State Before Submission:",n),!n.customerId){C("warning","Please select a customer or add a new customer");return}const d=n.items.filter(l=>l.product.toString().length>10).map(l=>({name:l.name||"Custom Product",size:typeof l.size=="string"?l.size:"Custom Size",price:l.price,qty:l.qty})),r=n.items.filter(l=>l.product.toString().length<=10).map(l=>({product_id:l.product,product_size_id:typeof l.size=="number"?l.size:null,qty:l.qty,price:l.price}));if(r.length===0&&d.length===0){C("error","You must add at least one product before submitting the order.");return}const V={customer_id:n.customerId,company_id:a,total_amount:n.billedAmount,paid_amount:n.paidAmount,balance_amount:n.balanceAmount,order_status:o,discount:n.discount,delivery_date:n.deliveryDate,invoiceDate:n.invoiceDate||null,order_type:n.invoiceType,payment_type:n.payment_type,products:r,custom_products:d.length>0?d:null};console.log("Sending Order Data:",JSON.stringify(V,null,2));try{const l=await fetch("/api/orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(V)});if(console.log("Response Status:",l.status),!l.ok)throw new Error(`HTTP error! Status: ${l.status}`);const w=await l.json();console.log("Order created successfully:",w),w.order&&w.order.id?(console.log("Redirecting to Invoice Page..."),ue(`/invoice-details/${w.order.id}`)):console.error("Order ID missing in response!")}catch(l){console.error("Fetch Error:",l)}},Ce=()=>{m({customerName:"",customerId:null,invoiceDate:new Date().toISOString().split("T")[0],items:[{product:"",size:"",price:0,qty:0,total:0}],discount:0,paidAmount:0,balanceAmount:0,billedAmount:0,totalAmount:0,products:[]}),N([]),g(!1),u(!1),$(null)},Ne=async()=>{try{de();const t=await P("/api/product");O(H([...t.filter(a=>a.show==1)]));const s=t.map(a=>({id:a.id,name:a.name,sizes:a.sizes.map(o=>({id:o.id,name:o.size,price:o.oPrice}))}));m(a=>({...a,products:s}))}catch{C("danger","Error fetching products.")}finally{me()}};return c.useEffect(()=>{Ne()},[]),e.jsxs(I,{children:[e.jsx(De,{hint:v.name,onSuccess:ve,visible:X,setVisible:z}),e.jsx(Fe,{visible:f,setVisible:u}),e.jsx(T,{xs:12,children:e.jsxs(Te,{className:"mb-4",children:[e.jsx(qe,{children:e.jsx("strong",{children:i("invoice.new_invoice")})}),e.jsx(Pe,{children:e.jsxs(Oe,{noValidate:!0,validated:b,onSubmit:be,children:[e.jsx("div",{className:"row mb-2",children:e.jsxs("div",{className:"col-9",children:[e.jsx(h,{type:"text",id:"pname",placeholder:i("invoice.customer_name"),name:"customerName",value:v.name,onChange:pe,autoComplete:"off",required:!0}),v.name&&v.name.length>0&&e.jsxs("ul",{className:"suggestions-list",children:[Y.map((t,s)=>e.jsxs("li",{onClick:()=>Q(t),children:[t.name," (",t.mobile,")"]},s)),!v.id&&e.jsx("li",{children:e.jsx(Ie,{role:"button",color:"danger",onClick:()=>z(!0),children:i("invoice.new_customer")})})]})]})}),v.id&&e.jsx("div",{className:"row",children:e.jsx("div",{className:"col-sm-12 mt-1",children:e.jsx(U,{color:"success",children:e.jsxs("p",{children:[e.jsxs("strong",{children:[i("invoice.name"),":"]})," ",v.name," (",v.mobile,") ",e.jsx("br",{}),v.address&&e.jsxs(e.Fragment,{children:[e.jsxs("strong",{children:[i("invoice.address"),": "]})," ",v.address]})]})})})}),e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(p,{htmlFor:"invoiceType",children:i("invoice.invoice_type")}),e.jsx(y,{"aria-label":i("invoice.select_invoice_type"),name:"invoiceType",value:n.invoiceType,options:[{label:i("invoice.regular"),value:1},{label:i("invoice.advance_booking"),value:2}],onChange:x,required:!0,feedbackInvalid:i("invoice.select_type")})]})}),e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(p,{htmlFor:"invoiceDate",children:i("invoice.invoice_date")}),e.jsx(h,{type:"date",id:"invoiceDate",placeholder:i("invoice.pune"),name:"invoiceDate",value:n.invoiceDate,onChange:x,required:!0,feedbackInvalid:i("invoice.select_date")})]})}),e.jsx("div",{className:"col-sm-4",children:n.invoiceType==2&&e.jsxs("div",{className:"mb-3",children:[e.jsx(p,{htmlFor:"deliveryDate",children:i("invoice.delivery_date")}),e.jsx(h,{type:"date",id:"deliveryDate",placeholder:i("invoice.pune"),name:"deliveryDate",value:n.deliveryDate,min:new Date().toISOString().split("T")[0],onChange:x,required:n.invoiceType==2,feedbackInvalid:i("invoice.select_date")})]})})]}),e.jsx("div",{className:"mb-3",children:e.jsx(ke,{id:"orderForOthers",label:"Delivery For Other",checked:k,onChange:oe})}),k&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(p,{htmlFor:"deliveryFor",children:"Delivery For"}),e.jsxs(y,{id:"deliveryFor",value:ee,onChange:ie,children:[e.jsx("option",{value:"",children:"Select"}),e.jsx("option",{value:"spouse",children:"Spouse"}),e.jsx("option",{value:"family",children:"Family"}),e.jsx("option",{value:"friend",children:"Friend"})]})]})}),e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(p,{htmlFor:"deliveryName",children:"Name"}),e.jsx(h,{type:"text",id:"deliveryName",name:"deliveryName",value:se,onChange:le,placeholder:"Please Enter Name"})]})}),e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(p,{htmlFor:"deliveryBirthdate",children:"Birthdate"}),e.jsx(h,{type:"date",id:"deliveryBirthdate",name:"deliveryBirthdate",value:ae,onChange:ce})]})})]})}),e.jsx("div",{className:"d-none d-md-block table-responsive",children:e.jsxs("table",{className:"table table-bordered",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Product"}),e.jsx("th",{children:"Size"}),e.jsx("th",{children:"Price"}),e.jsx("th",{children:"Quantity"}),e.jsx("th",{children:"Total Price"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:Array.isArray(n.items)&&n.items.length>0?n.items.map((t,s)=>{var d;const a=Array.isArray(n.products)?n.products.find(r=>r.id===t.product):null,o=a?a.sizes:[];return e.jsxs("tr",{children:[e.jsx("td",{children:t.name?e.jsx("span",{children:t.name}):e.jsxs(y,{value:t.product||"",onChange:r=>B(s,parseInt(r.target.value)),children:[e.jsx("option",{value:"",children:"Select Product"}),Array.isArray(n.products)&&n.products.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})}),e.jsx("td",{children:t.name?e.jsx("span",{children:typeof t.size=="string"?t.size:((d=o.find(r=>r.id===t.size))==null?void 0:d.name)||"No Size Selected"}):e.jsxs(y,{value:t.size||"",onChange:r=>E(s,parseInt(r.target.value)),disabled:!t.product||o.length===0,children:[e.jsx("option",{value:"",children:"Select Size"}),o.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})}),e.jsx("td",{children:t.price||"-"}),e.jsx("td",{children:e.jsx(h,{type:"number",value:t.qty===0?"":t.qty,placeholder:"0",onFocus:r=>r.target.value==="0"&&(r.target.value=""),onBlur:r=>r.target.value===""&&A(s,0),onChange:r=>A(s,parseInt(r.target.value,10)||0)})}),e.jsxs("td",{children:[(t.price*(t.qty||1)).toFixed(2)," â‚¹"]}),e.jsx("td",{children:e.jsxs("div",{className:"d-flex",children:[n.items.length>1&&e.jsx(j,{color:"danger",onClick:()=>M(s),children:e.jsx(D,{icon:J,size:"sm"})}),s===n.items.length-1&&e.jsx(j,{color:"success",onClick:R,children:e.jsx(D,{icon:L,size:"sm"})})]})})]},s)}):e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"text-center",children:"No items found"})})})]})}),e.jsx("div",{className:"d-block d-md-none",children:Array.isArray(n.items)&&n.items.length>0?n.items.map((t,s)=>{var d;const a=Array.isArray(n.products)?n.products.find(r=>r.id===t.product):null,o=a?a.sizes:[];return e.jsxs("div",{className:"bg-light rounded p-3 my-3",children:[e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsxs("div",{style:{flex:1},children:[e.jsx("label",{className:"font-weight-bold",children:"Product:"}),t.name?e.jsx("p",{children:t.name}):e.jsxs(y,{value:t.product||"",onChange:r=>B(s,parseInt(r.target.value)),children:[e.jsx("option",{value:"",children:"Select Product"}),Array.isArray(n.products)&&n.products.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})]}),e.jsxs("div",{style:{flex:1,marginLeft:"10px"},children:[e.jsx("label",{className:"font-weight-bold",children:"Size:"}),t.name?e.jsx("p",{children:typeof t.size=="string"?t.size:((d=o.find(r=>r.id===t.size))==null?void 0:d.name)||"No Size Selected"}):e.jsxs(y,{value:t.size||"",onChange:r=>E(s,parseInt(r.target.value)),disabled:!t.product||o.length===0,children:[e.jsx("option",{value:"",children:"Select Size"}),o.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})]})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-3",children:[e.jsxs("div",{style:{flex:1},children:[e.jsx("label",{className:"font-weight-bold",children:"Price:"}),e.jsx("p",{children:t.price||"-"})]}),e.jsxs("div",{style:{flex:1,marginLeft:"10px"},children:[e.jsx("label",{className:"font-weight-bold",children:"Quantity:"}),e.jsx(h,{type:"number",value:t.qty===0?"":t.qty,placeholder:"0",onFocus:r=>r.target.value==="0"&&(r.target.value=""),onBlur:r=>r.target.value===""&&A(s,0),onChange:r=>A(s,parseInt(r.target.value,10)||0),style:{width:"80px",padding:"5px",fontSize:"14px"}})]}),e.jsxs("div",{className:"d-flex justify-content-end mt-3",children:[n.items.length>1&&e.jsx(j,{color:"danger",onClick:()=>M(s),children:e.jsx(D,{icon:J,size:"sm"})}),s===n.items.length-1&&e.jsx(j,{color:"success",onClick:R,className:"ms-2",children:e.jsx(D,{icon:L,size:"sm"})})]})]})]},s)}):e.jsx("div",{className:"text-center",children:"No items found"})}),e.jsxs("div",{className:"d-flex justify-content-between",style:{marginBottom:"13px"},children:[e.jsx(j,{color:"primary",onClick:()=>_(!0),children:"Customize Order"}),e.jsx(T,{className:"text-end",style:{marginRight:"30px"},children:e.jsxs("h6",{children:["Total: â‚¹",n.totalAmount]})})]}),e.jsx("div",{children:e.jsx(I,{children:e.jsxs(T,{xs:12,md:6,children:[e.jsx(p,{htmlFor:"payment_type",children:"Payment Type"}),e.jsxs(y,{id:"payment_type",name:"payment_type",value:n.payment_type,onChange:x,children:[e.jsx("option",{value:0,children:i("invoice.cash")}),e.jsx("option",{value:1,children:i("invoice.online")})]})]})})}),e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-sm-2",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(p,{htmlFor:"discount",children:[i("invoice.discount")," (%)"]}),e.jsx(h,{type:"number",id:"discount",placeholder:"0",name:"discount",value:n.discount===0?"":n.discount,onChange:t=>{const s=t.target.value===""?"":Math.max(0,Math.min(100,t.target.value));x({target:{name:"discount",value:s}})}})]})}),e.jsx("div",{className:"col-sm-3",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(p,{htmlFor:"paidAmount",children:[i("invoice.paid_amount")," (Rs)"]}),e.jsx(h,{type:"number",id:"paidAmount",placeholder:"0",name:"paidAmount",value:n.paidAmount===0?"":n.paidAmount,onChange:t=>{const s=t.target.value===""?"":Math.max(0,t.target.value);x({target:{name:"paidAmount",value:s}})}})]})}),e.jsx("div",{className:"col-sm-3",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(p,{htmlFor:"paidAmount",children:[i("invoice.balance_amount")," (Rs)"]}),e.jsx(h,{type:"number",id:"balanceAmount",placeholder:"",readOnly:!0,name:"balanceAmount",value:n.balanceAmount,onChange:x})]})}),e.jsx("div",{className:"col-sm-2",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(p,{htmlFor:"finalAmount",children:[i("invoice.final_amount")," (Rs)"]}),e.jsx(h,{type:"number",id:"finalAmount",placeholder:"",name:"finalAmount",readOnly:!0,value:n.billedAmount,onChange:x})]})})]}),e.jsx("div",{children:q&&e.jsx(I,{children:e.jsx(U,{color:"danger",children:q})})}),e.jsxs("div",{className:"mb-3 mt-3",children:[e.jsx(j,{color:"success",type:"submit",children:i("invoice.submit")}),"Â ",e.jsx(j,{color:"secondary",onClick:Ce,children:i("invoice.clear")}),"Â ",n.payment_type==1&&e.jsx(j,{className:"mr-20",type:"button",onClick:()=>u(!0),color:"primary",children:i("invoice.view_qr")})]})]})})]})}),e.jsx(_e,{visible:W,setVisible:_,onAddProduct:fe})]})};export{nt as default};
