import{r as n,x as xe,w as be,j as e,a as je}from"./index-CoZNXrT3.js";import{Q as ge,N as Se}from"./NewCustomerModal-BhqB8eUB.js";import{f as B,h as ve,p as q}from"./api-8_quPuaU.js";import{C as Y}from"./ConfirmationModal-nQXrvx9v.js";import{u as fe,C as w}from"./DefaultLayout-BFij5oOH.js";import{C as Ce}from"./CRow-C1kAJa4E.js";import{C as Le}from"./CCol-6gv0qfQb.js";import{C as Ae,a as _e}from"./CCardBody-KiBmAR96.js";import{C as Ee}from"./CCardHeader-CzKoGM0V.js";import{C as Ne}from"./CForm-CWuSMnRv.js";import{C as h}from"./CFormInput-D071rTfS.js";import{C as Be}from"./cil-mobile-BFL8AfvV.js";import{C as d}from"./CFormLabel-DOuP-TYD.js";import{C as we}from"./CFormSelect-CVgASmge.js";import{a as T}from"./index.esm-DG3saitl.js";import"./CModalTitle-yUagMCk3.js";let X;const Je=()=>{var $;const[J,k]=n.useState(!1),[K,F]=n.useState(!1),[U,v]=n.useState(!1),[W,y]=n.useState(!1),[Z,P]=n.useState(!1),[f,I]=n.useState(),[x,C]=n.useState([]),[b,z]=n.useState(),[L,V]=n.useState([]),A=()=>`${new Date().getHours()}:${new Date().getMinutes().toString().padStart(2,"0")}`,[i,j]=n.useState({customer_id:0,lat:"",long:"",payLater:!1,isSettled:!1,invoiceDate:new Date().toISOString().split("T")[0],deliveryTime:A(),deliveryDate:"",invoiceType:1,items:[],totalAmount:0,orderStatus:1,discount:0,balanceAmount:0,paidAmount:0,finalAmount:0,paymentType:1}),[ee,G]=n.useState(!1),{showSpinner:g,hideSpinner:S}=xe(),{t:r,i18n:te}=fe("global"),Q=te.language,{showToast:o}=be(),[c,D]=n.useState({}),[se,_]=n.useState([]),re=((t,s)=>function(...a){clearTimeout(X),X=setTimeout(()=>{t.apply(this,a)},s)})(async t=>{try{const s=await B("/api/searchCustomer?searchQuery="+t);s!=null&&s.length?_(s):_([])}catch(s){o("danger","Error occured "+s)}},750),ae=t=>{const s=t.target.value;D({name:s}),s?re(s):_([])},R=t=>{D(t),j(a=>({...a,customer_id:t.id}));const s=H([...x],t.discount);C(s),O(s),_([]),ne(t.id),le(t.id)},oe=t=>{R(t),v(!1)},ne=async t=>{try{const s=await B("/api/customerHistory?id="+t);s&&z(s)}catch(s){o("danger","Error occured "+s)}},le=async t=>{g();try{const s=await B("/api/customerBookings?id="+t);s&&V(s)}catch(s){o("danger","Error occured "+s)}finally{S()}},H=(t,s)=>(t.forEach(a=>{a.sizes[0].dPrice=M(a,s)}),t),M=(t,s)=>{const a=t.sizes[0].oPrice,l=a-a*(s||(c.discount??0))/100;return Math.round(l)},ie=async()=>{try{g();const t=await B("/api/product");C(H([...t.filter(s=>s.show==1&&s.showOnHome==1)]))}catch(t){o("danger","Error occured "+t)}finally{S()}},O=t=>{let s=0;t.forEach(a=>{s+=(a.dQty??0)*a.sizes[0].dPrice}),j(a=>({...a,totalAmount:s}))};n.useEffect(()=>{ie()},[]);const E=t=>{const{name:s,value:a}=t.target;j({...i,[s]:a})},ce=async t=>{try{const s=t.currentTarget;if(t.preventDefault(),t.stopPropagation(),ee)return;G(!0);let a=!1,l={...i,deliveryDate:i.invoiceDate,finalAmount:i.totalAmount,deliveryTime:A(),items:[]};x.forEach(m=>{if(m.dQty>0||m.eQty>0){const u=m.sizes[0];let ye={...m,product_sizes_id:u.id,size_name:u.name,size_local_name:u.localName,oPrice:u.oPrice,bPrice:u.bPrice,dPrice:u.dPrice,total_price:u.dPrice*m.dQty};l.items.push({...ye})}});const pe=l.customer_id>0&&(l.paidAmount>0||l.items.length);if(!a&&pe){g();const m=await ve("/api/order",{...l});m&&(m.id?(N(),o("success",r("MSG.order_is_delivered_msg"))):o("danger",r("MSG.error_occured_msg")))}else o("warning",r("MSG.provide_valid_data_msg")),j(l),k(!0)}catch{o("danger",r("MSG.error_placing_the_order_msg"))}S(),G(!1)},N=async()=>{j({customer_id:0,lat:"",long:"",payLater:!1,isSettled:!1,invoiceDate:new Date().toISOString().split("T")[0],deliveryTime:A(),deliveryDate:"",invoiceType:1,items:[],totalAmount:0,discount:0,balanceAmount:0,paidAmount:0,finalAmount:0,paymentType:1,orderStatus:1});const t=[...x];t.forEach(s=>{s.eQty=0,s.dQty=0}),C([...t]),D({name:""}),z(void 0),V([]),y(!1),P(!1),k(!1)},p=(t,s,a)=>{const l=[...x];l[t][a]=s,C([...l]),O(l)},de=t=>{I(t),y(!0)},me=t=>{I(t),P(!0)},ue=async()=>{g();try{const t=await q(`/api/order/${f.id}`,{...f,lat:i.lat,long:i.long,deliveryTime:A(),deliveryDate:new Date().toISOString().split("T")[0],orderStatus:1});t&&(t.id?(N(),o("success",r("MSG.order_is_delivered_msg"))):o("danger",r("MSG.order_is_already_delivered_msg")))}catch(t){o("danger","Error occured "+t)}S()},he=async()=>{g();try{(await q(`/api/order/${f.id}`,{...f,orderStatus:0})).id?o("success",r("MSG.order_is_cancelled_msg")):o("danger",r("MSG.order_is_already_cancelled_msg")),y(!1),N()}catch(t){y(!1),o("danger","Error occured "+t)}S()};return e.jsxs(Ce,{children:[e.jsx(Y,{visible:W,setVisible:y,onYes:he,resource:r("LABELS.cancel_order")}),e.jsx(Y,{visible:Z,setVisible:P,onYes:ue,resource:r("LABELS.deliver_order")}),e.jsx(ge,{visible:K,setVisible:F}),e.jsx(Se,{hint:c.name,onSuccess:oe,visible:U,setVisible:v}),e.jsx(Le,{xs:12,children:e.jsxs(Ae,{className:"mb-4",children:[e.jsx(Ee,{children:e.jsx("strong",{children:r("LABELS.delivery_record")})}),e.jsx(_e,{children:e.jsxs(Ne,{noValidate:!0,validated:J,onSubmit:ce,children:[e.jsxs("div",{className:"row mb-2",children:[e.jsxs("div",{className:"col-8",children:[e.jsx(h,{type:"text",id:"pname",placeholder:r("LABELS.customer_name"),name:"customerName",value:c.name,onChange:ae,feedbackInvalid:r("MSG.please_provide_name"),autoComplete:"off",required:!0}),(($=c.name)==null?void 0:$.length)>0&&e.jsxs("ul",{className:"suggestions-list",children:[se.map((t,s)=>e.jsx("li",{onClick:()=>R(t),children:t.name+" ("+t.mobile+")"},s)),!c.id&&e.jsx("li",{children:e.jsx(w,{role:"button",color:"danger",onClick:()=>v(!0),children:r("LABELS.new_customer")})})]})]}),e.jsx("div",{className:"col-4",children:e.jsx(w,{role:"button",color:"danger",style:{padding:"10px 8px",float:"right"},onClick:()=>v(!0),children:r("LABELS.new")})})]}),c.id&&e.jsx("div",{className:"row",children:e.jsx("div",{className:"col-sm-12 mt-1",children:e.jsxs(Be,{color:"success",children:[e.jsxs("p",{children:[e.jsxs("strong",{children:[r("LABELS.name"),":"]})," ",c.name," (",c.mobile,") ",e.jsx("br",{}),c.address&&e.jsxs(e.Fragment,{children:[e.jsxs("strong",{children:[r("LABELS.address"),": "]})," ",c.address]}),b&&e.jsxs(e.Fragment,{children:[b.pendingPayment>0&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),r("LABELS.credit")," ",e.jsx("strong",{className:"text-danger",children:b.pendingPayment})," ",r("LABELS.rs"),"."]}),b.pendingPayment<0&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),r("LABELS.balance")," (",r("LABELS.advance"),") ",e.jsx("strong",{className:"text-success",children:b.pendingPayment*-1})," ",r("LABELS.rs"),"."]})]})]}),(L==null?void 0:L.length)>0&&e.jsx("table",{className:"table table-sm borderless",children:e.jsx("tbody",{children:L.map(t=>e.jsxs(je.Fragment,{children:[t.items.map((s,a)=>e.jsxs("tr",{children:[e.jsx("td",{children:(Q==="en"?s.product_name:s.product_local_name)+" "+s.dQty+" X "+s.dPrice+"₹ = ₹"+s.total_price}),a===0&&e.jsxs("td",{rowSpan:t.items.length+1,children:[e.jsx(w,{role:"button",color:"info",onClick:()=>me(t),children:r("LABELS.deliver")})," ",e.jsx("br",{}),e.jsx(w,{role:"button",color:"danger",onClick:()=>de(t),children:r("LABELS.cancel")})]}),a!==0&&e.jsx("td",{})]},s.id)),e.jsx("tr",{children:e.jsxs("td",{children:[r("LABELS.advance")+"₹ "+t.paidAmount+" "+r("LABELS.balance")+" ₹",e.jsx("span",{className:"text-danger",children:t.totalAmount-t.paidAmount})]})})]},t.id))})})]})})}),e.jsxs("div",{className:"side-by-side  d-none",children:[e.jsxs("div",{className:"col-sm-6 mb-3 pr-5",children:[e.jsx(d,{htmlFor:"invoiceType",children:r("LABELS.order_type")}),e.jsx(we,{"aria-label":"Select Product Type",name:"invoiceType",value:i.invoiceType,options:[{label:"Regular",value:1},{label:"Advance Booking",value:2}],onChange:E,required:!0,feedbackInvalid:"Please select type."})]}),e.jsxs("div",{className:"col-sm-6 mb-3",children:[e.jsx(d,{htmlFor:"invoiceDate",children:r("LABELS.date")}),e.jsx(h,{type:"date",id:"invoiceDate",placeholder:"Pune",name:"invoiceDate",date:new Date,value:i.invoiceDate,onChange:E,required:!0,feedbackInvalid:"Please select date."})]})]}),x.map((t,s)=>e.jsxs("div",{className:"row bottom-border",children:[e.jsxs("div",{className:"col-6 mb-3 pr-5",children:[e.jsx(d,{htmlFor:"product",children:Q==="en"?t.name:t.localName}),e.jsxs("div",{className:"input-group",children:[e.jsx("button",{className:"btn btn-danger",type:"button",onClick:()=>{p(s,Math.max(0,(t.dQty??1)-1),"dQty")},children:"-"}),e.jsx(h,{type:"number",id:"dQty",placeholder:"0",name:"dQty",value:t.dQty,onChange:a=>{p(s,parseInt(a.target.value??"0"),"dQty")},min:"0"}),e.jsx("button",{className:"btn btn-success",type:"button",onClick:()=>{p(s,Math.max(0,(t.dQty??0)+1),"dQty")},children:"+"})]})]}),e.jsxs("div",{className:"col-3 mb-3 pr-5 d-none",children:[e.jsx(d,{htmlFor:"product",children:r("LABELS.rate")}),e.jsx(h,{type:"number",readOnly:!0,disabled:!0,value:t.sizes[0].oPrice})]}),e.jsxs("div",{className:"col-3 mb-3 pr-5",children:[e.jsx(d,{htmlFor:"product",children:r("LABELS.rate")}),e.jsx("br",{}),M(t)]}),e.jsxs("div",{className:"col-3 mb-3 pr-5",children:[e.jsx(d,{htmlFor:"product",children:r("LABELS.total")}),e.jsx("br",{}),M(t)*t.dQty||0]}),t.sizes[0].returnable===1&&e.jsxs("div",{className:"col-6 mb-3 pr-5",children:[e.jsxs(d,{htmlFor:"product",children:[r("LABELS.empty")," ",Q==="en"?t.name:t.localName]}),e.jsxs("div",{className:"input-group",children:[e.jsx("button",{className:"btn btn-danger",type:"button",onClick:()=>p(s,Math.max(0,(t.eQty??0)-1),"eQty"),children:"-"}),e.jsx(h,{type:"number",id:"eQty",placeholder:"0",name:"eQty",value:t.eQty??0,onChange:a=>{p(s,parseInt(a.target.value??"0"),"eQty")},min:"0"}),e.jsx("button",{className:"btn btn-success",type:"button",onClick:()=>p(s,Math.max(0,(t.eQty??0)+1),"eQty"),children:"+"})]})]})]},t.id)),e.jsxs("div",{className:"side-by-side",children:[e.jsxs("div",{className:"col-sm-3 mb-3 pr-5",children:[e.jsx(d,{htmlFor:"totalAmount",children:r("LABELS.total_amount")}),e.jsx(h,{type:"number",id:"totalAmount",placeholder:"0",name:"totalAmount",readOnly:!0,disabled:!0,value:i.totalAmount,onChange:E})]}),e.jsxs("div",{className:"col-sm-3 mb-3 pr-5",children:[e.jsx(d,{htmlFor:"bPrice",children:r("LABELS.cash_collected")}),e.jsx(h,{type:"number",id:"paidAmount",placeholder:"0",name:"paidAmount",value:i.paidAmount,onChange:E})]})]}),e.jsxs("div",{className:"side-by-side",children:[e.jsx(T,{type:"submit",color:"success",children:r("LABELS.submit")}),"   ",e.jsx(T,{className:"mr-20",type:"button",onClick:N,color:"danger",children:r("LABELS.clear")}),"   ",e.jsx(T,{className:"mr-20",type:"button",onClick:()=>{F(!0)},color:"primary",children:r("LABELS.view_QR")})]})]})})]})})]})};export{Je as default};
