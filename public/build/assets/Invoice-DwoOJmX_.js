import{r as c,x as Se,w as Ae,m as we,j as e}from"./index-Bg23EJBh.js";import{N as ze,Q as Fe}from"./NewCustomerModal-Mrtv-Pma.js";import{a as j,c as S}from"./index.esm-8VmjjbFz.js";import{f as _}from"./api-8_quPuaU.js";import{c as V,a as J,C as De}from"./CustomProductModal-BpK3eCHL.js";import{u as _e,C as Te}from"./DefaultLayout-ClwM_41s.js";import{C as F}from"./CRow-Cu5LofkQ.js";import{C as D}from"./CCol-YFH1-bI8.js";import{C as Ie,a as Pe}from"./CCardBody-Jm5-jwwI.js";import{C as Oe}from"./CCardHeader-VfQPesaz.js";import{C as qe}from"./CForm-DKH37w0G.js";import{C as h}from"./CFormInput-DUEAMG4e.js";import{C as L}from"./cil-mobile-BTelR--Q.js";import{C as p}from"./CFormLabel-Cqbh7rjs.js";import{C as y}from"./CFormSelect-CaG7Qby9.js";import{C as ke}from"./CFormCheck-BYapryZ9.js";import"./CModalTitle-CtLHuCtH.js";const Be=(b,g)=>{let f;return function(...u){clearTimeout(f),f=setTimeout(()=>b(...u),g)}},Ee=async(b,g,f)=>{try{const u=await _("/api/searchCustomer?searchQuery="+b);u!=null&&u.length?g(u):g([])}catch(u){f("danger","Error occurred "+u)}},ns=()=>{const[b,g]=c.useState(!1),[f,u]=c.useState(!1),[T,U]=c.useState(),[$,C]=c.useState([]),[Re,Y]=c.useState(),[G,I]=c.useState(),[v,P]=c.useState({name:"",mobile:"",address:"",id:null});c.useState(null),c.useState({name:"",size:"",price:0,qty:0});const[K,A]=c.useState(!1),[W,w]=c.useState(!1),[O,X]=c.useState(!1),[Z,ee]=c.useState(""),[se,te]=c.useState(""),[ne,ie]=c.useState(""),[n,m]=c.useState({customerName:"",company_id:null,customerId:null,invoiceType:1,invoiceDate:new Date().toISOString().split("T")[0],deliveryDate:new Date().toISOString().split("T")[0],deliveryFor:"",deliveryName:"",deliveryBirthdate:new Date().toISOString().split("T")[0],items:[{product:"",size:"",price:0,qty:1}],relative:[],totalAmount:0,finalAmount:0,balanceAmount:0,discount:0,paidAmount:0,orderStatus:1}),re=s=>{X(s.target.checked)},ae=s=>{ee(s.target.value)},oe=s=>{te(s.target.value)},le=s=>{ie(s.target.value)},{showSpinner:ce,hideSpinner:de}=Se(),{showToast:z}=Ae(),me=we(),{t:o}=_e("global"),ue=Be(s=>{Ee(s,C,z)},750),he=s=>{const t=s.target.value;P({name:t}),m(i=>({...i,customerName:t})),t?ue(t):C([])},pe=s=>{M(s),w(!1)},x=s=>{const{name:t,value:i}=s.target;m(a=>({...a,[t]:i}))};c.useEffect(()=>{ve()},[n.items]),c.useEffect(()=>{xe()},[n.totalAmount,n.discount]),c.useEffect(()=>{je()},[n.billedAmount,n.paidAmount]);const ve=()=>{const s=n.items.reduce((t,i)=>t+i.qty*i.price,0);m(t=>({...t,totalAmount:s}))},xe=()=>{const s=n.totalAmount*n.discount/100,t=n.totalAmount-s;m(i=>({...i,billedAmount:t}))},je=()=>{const s=n.billedAmount-n.paidAmount;m(t=>({...t,balanceAmount:s}))},q=(s,t)=>{if(!n.products)return;const i=n.products.find(d=>d.id===t),a=[...n.items];a[s]={...a[s],product:t,size:"",price:(i==null?void 0:i.price)||0,total:0},m(d=>({...d,items:a}))},k=(s,t)=>{const i=n.products.find(r=>r.id===n.items[s].product),a=i==null?void 0:i.sizes.find(r=>r.id===t),d=[...n.items];d[s]={...d[s],size:t,price:(a==null?void 0:a.price)||0,total:d[s].qty*((a==null?void 0:a.price)||0)},m(r=>({...r,items:d}))},B=(s,t)=>{const i=[...n.items];i[s]={...i[s],qty:t,total:t*i[s].price},m(a=>({...a,items:i}))},E=()=>{m(s=>({...s,items:[...s.items,{product:"",size:"",price:0,qty:0,total:0}]}))},R=s=>{const t=n.items.filter((i,a)=>a!==s);m(i=>({...i,items:t}))},ye=s=>{let t=0;return s.forEach(i=>{t+=i.total}),t},ge=async s=>{try{const t=await _("/api/customerHistory?id="+s);t&&Y(t)}catch(t){z("danger","Error occured "+t)}},M=s=>{console.log("Selected Suggestion:",s),P(s),console.log("Updated customerName:",s),m(i=>{const a={...i,customerId:s.id};return console.log("Updated State:",a),a});const t=Q([...G],s.discount);console.log("Updated Products with Discount:",t),I(t),ye(t),C([]),console.log("Suggestions cleared"),ge(s.id),console.log("Fetching customer history for ID:",s.id)},Q=(s,t)=>(s.forEach(i=>{i.sizes[0].dPrice=getDiscountedPrice(i,t)}),s),fe=s=>{if(!s.name||s.name.trim()===""){alert("Custom product name is required!");return}if(!s.size||s.size.trim()===""){alert("Custom product size is required!");return}const t={id:Date.now(),name:s.name,size:s.size,price:s.price,qty:s.qty};m(i=>{let a=[...i.items];return a.length===1&&!a[0].product?a[0]={...t,product:t.id,total:t.price*t.qty}:a.push({...t,product:t.id,total:t.price*t.qty}),{...i,items:a}}),A(!1)},be=async s=>{s.preventDefault();const t=JSON.parse(localStorage.getItem("userData")),i=t?t==null?void 0:t.user.company_id:null,a=n.invoiceType===1?1:2;console.log("ðŸš€ Form State Before Submission:",n);const d=n.items.filter(l=>l.product.toString().length>10).map(l=>({name:l.name||"Custom Product",size:typeof l.size=="string"?l.size:"Custom Size",price:l.price,qty:l.qty})),r=n.items.filter(l=>l.product.toString().length<=10).map(l=>({product_id:l.product,product_size_id:typeof l.size=="number"?l.size:null,qty:l.qty,price:l.price}));if(r.length===0&&d.length===0){alert("You must add at least one product before submitting the order.");return}const H={customer_id:n.customerId,company_id:i,total_amount:n.billedAmount,paid_amount:n.paidAmount,balance_amount:n.balanceAmount,order_status:a,discount:n.discount,delivery_date:n.deliveryDate,invoiceDate:n.invoiceDate||null,order_type:n.invoiceType,products:r,custom_products:d.length>0?d:null};console.log("ðŸ“¦ Sending Order Data:",JSON.stringify(H,null,2));try{const l=await fetch("/api/orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(H)});if(console.log("ðŸŸ¡ Response Status:",l.status),!l.ok)throw new Error(`HTTP error! Status: ${l.status}`);const N=await l.json();console.log("âœ… Order created successfully:",N),N.order&&N.order.id?(console.log("ðŸ”€ Redirecting to Invoice Page..."),me(`/invoice-details/${N.order.id}`)):console.error("âŒ Order ID missing in response!")}catch(l){console.error("âŒ Fetch Error:",l)}},Ce=()=>{m({customerName:"",customerId:null,invoiceDate:new Date().toISOString().split("T")[0],items:[{product:"",size:"",price:0,qty:0,total:0}],discount:0,paidAmount:0,balanceAmount:0,billedAmount:0,totalAmount:0,products:[]}),C([]),g(!1),u(!1),U(null)},Ne=async()=>{try{ce();const s=await _("/api/product");I(Q([...s.filter(i=>i.show==1)]));const t=s.map(i=>({id:i.id,name:i.name,sizes:i.sizes.map(a=>({id:a.id,name:a.size,price:a.oPrice}))}));m(i=>({...i,products:t}))}catch{z("danger","Error fetching products.")}finally{de()}};return c.useEffect(()=>{Ne()},[]),e.jsxs(F,{children:[e.jsx(ze,{hint:v.name,onSuccess:pe,visible:W,setVisible:w}),e.jsx(Fe,{visible:f,setVisible:u}),e.jsx(D,{xs:12,children:e.jsxs(Ie,{className:"mb-4",children:[e.jsx(Oe,{children:e.jsx("strong",{children:o("invoice.new_invoice")})}),e.jsx(Pe,{children:e.jsxs(qe,{noValidate:!0,validated:b,onSubmit:be,children:[e.jsx("div",{className:"row mb-2",children:e.jsxs("div",{className:"col-9",children:[e.jsx(h,{type:"text",id:"pname",placeholder:o("invoice.customer_name"),name:"customerName",value:v.name,onChange:he,autoComplete:"off",required:!0}),v.name&&v.name.length>0&&e.jsxs("ul",{className:"suggestions-list",children:[$.map((s,t)=>e.jsxs("li",{onClick:()=>M(s),children:[s.name," (",s.mobile,")"]},t)),!v.id&&e.jsx("li",{children:e.jsx(Te,{role:"button",color:"danger",onClick:()=>w(!0),children:o("invoice.new_customer")})})]})]})}),v.id&&e.jsx("div",{className:"row",children:e.jsx("div",{className:"col-sm-12 mt-1",children:e.jsx(L,{color:"success",children:e.jsxs("p",{children:[e.jsxs("strong",{children:[o("invoice.name"),":"]})," ",v.name," (",v.mobile,") ",e.jsx("br",{}),v.address&&e.jsxs(e.Fragment,{children:[e.jsxs("strong",{children:[o("invoice.address"),": "]})," ",v.address]})]})})})}),e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(p,{htmlFor:"invoiceType",children:o("invoice.invoice_type")}),e.jsx(y,{"aria-label":o("invoice.select_invoice_type"),name:"invoiceType",value:n.invoiceType,options:[{label:o("invoice.regular"),value:1},{label:o("invoice.advance_booking"),value:2}],onChange:x,required:!0,feedbackInvalid:o("invoice.select_type")})]})}),e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(p,{htmlFor:"invoiceDate",children:o("invoice.invoice_date")}),e.jsx(h,{type:"date",id:"invoiceDate",placeholder:o("invoice.pune"),name:"invoiceDate",value:n.invoiceDate,onChange:x,required:!0,feedbackInvalid:o("invoice.select_date")})]})}),e.jsx("div",{className:"col-sm-4",children:n.invoiceType==2&&e.jsxs("div",{className:"mb-3",children:[e.jsx(p,{htmlFor:"deliveryDate",children:o("invoice.delivery_date")}),e.jsx(h,{type:"date",id:"deliveryDate",placeholder:o("invoice.pune"),name:"deliveryDate",value:n.deliveryDate,onChange:x,required:n.invoiceType==2,feedbackInvalid:o("invoice.select_date")})]})})]}),e.jsx("div",{className:"mb-3",children:e.jsx(ke,{id:"orderForOthers",label:"Delivery For Other",checked:O,onChange:re})}),O&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(p,{htmlFor:"deliveryFor",children:"Delivery For"}),e.jsxs(y,{id:"deliveryFor",value:Z,onChange:ae,children:[e.jsx("option",{value:"",children:"Select"}),e.jsx("option",{value:"spouse",children:"Spouse"}),e.jsx("option",{value:"family",children:"Family"}),e.jsx("option",{value:"friend",children:"Friend"})]})]})}),e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(p,{htmlFor:"deliveryName",children:"Name"}),e.jsx(h,{type:"text",id:"deliveryName",name:"deliveryName",value:se,onChange:oe,placeholder:"Please Enter Name"})]})}),e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(p,{htmlFor:"deliveryBirthdate",children:"Birthdate"}),e.jsx(h,{type:"date",id:"deliveryBirthdate",name:"deliveryBirthdate",value:ne,onChange:le})]})})]})}),e.jsx("div",{className:"d-none d-md-block table-responsive",children:e.jsxs("table",{className:"table table-bordered",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Product"}),e.jsx("th",{children:"Size"}),e.jsx("th",{children:"Price"}),e.jsx("th",{children:"Quantity"}),e.jsx("th",{children:"Total Price"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:Array.isArray(n.items)&&n.items.length>0?n.items.map((s,t)=>{var d;const i=Array.isArray(n.products)?n.products.find(r=>r.id===s.product):null,a=i?i.sizes:[];return e.jsxs("tr",{children:[e.jsx("td",{children:s.name?e.jsx("span",{children:s.name}):e.jsxs(y,{value:s.product||"",onChange:r=>q(t,parseInt(r.target.value)),children:[e.jsx("option",{value:"",children:"Select Product"}),Array.isArray(n.products)&&n.products.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})}),e.jsx("td",{children:s.name?e.jsx("span",{children:typeof s.size=="string"?s.size:((d=a.find(r=>r.id===s.size))==null?void 0:d.name)||"No Size Selected"}):e.jsxs(y,{value:s.size||"",onChange:r=>k(t,parseInt(r.target.value)),disabled:!s.product||a.length===0,children:[e.jsx("option",{value:"",children:"Select Size"}),a.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})}),e.jsx("td",{children:s.price||"-"}),e.jsx("td",{children:e.jsx(h,{type:"number",value:s.qty||1,onChange:r=>B(t,parseInt(r.target.value,10))})}),e.jsxs("td",{children:[(s.price*(s.qty||1)).toFixed(2)," â‚¹"]}),e.jsx("td",{children:e.jsxs("div",{className:"d-flex",children:[n.items.length>1&&e.jsx(j,{color:"danger",onClick:()=>R(t),children:e.jsx(S,{icon:V,size:"sm"})}),t===n.items.length-1&&e.jsx(j,{color:"success",onClick:E,children:e.jsx(S,{icon:J,size:"sm"})})]})})]},t)}):e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"text-center",children:"No items found"})})})]})}),e.jsx("div",{className:"d-block d-md-none",children:Array.isArray(n.items)&&n.items.length>0?n.items.map((s,t)=>{var d;const i=Array.isArray(n.products)?n.products.find(r=>r.id===s.product):null,a=i?i.sizes:[];return e.jsxs("div",{className:"bg-light rounded p-3 my-3",children:[e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsxs("div",{style:{flex:1},children:[e.jsx("label",{className:"font-weight-bold",children:"Product:"}),s.name?e.jsx("p",{children:s.name}):e.jsxs(y,{value:s.product||"",onChange:r=>q(t,parseInt(r.target.value)),children:[e.jsx("option",{value:"",children:"Select Product"}),Array.isArray(n.products)&&n.products.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})]}),e.jsxs("div",{style:{flex:1,marginLeft:"10px"},children:[e.jsx("label",{className:"font-weight-bold",children:"Size:"}),s.name?e.jsx("p",{children:typeof s.size=="string"?s.size:((d=a.find(r=>r.id===s.size))==null?void 0:d.name)||"No Size Selected"}):e.jsxs(y,{value:s.size||"",onChange:r=>k(t,parseInt(r.target.value)),disabled:!s.product||a.length===0,children:[e.jsx("option",{value:"",children:"Select Size"}),a.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})]})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-3",children:[e.jsxs("div",{style:{flex:1},children:[e.jsx("label",{className:"font-weight-bold",children:"Price:"}),e.jsx("p",{children:s.price||"-"})]}),e.jsxs("div",{style:{flex:1,marginLeft:"10px"},children:[e.jsx("label",{className:"font-weight-bold",children:"Quantity:"}),e.jsx(h,{type:"number",value:s.qty||1,onChange:r=>B(t,parseInt(r.target.value,10)),style:{width:"80px",padding:"5px",fontSize:"14px"}})]}),e.jsxs("div",{className:"d-flex justify-content-end mt-3",children:[n.items.length>1&&e.jsx(j,{color:"danger",onClick:()=>R(t),children:e.jsx(S,{icon:V,size:"sm"})}),t===n.items.length-1&&e.jsx(j,{color:"success",onClick:E,className:"ms-2",children:e.jsx(S,{icon:J,size:"sm"})})]})]})]},t)}):e.jsx("div",{className:"text-center",children:"No items found"})}),e.jsxs("div",{className:"d-flex justify-content-between",style:{marginBottom:"13px"},children:[e.jsx(j,{color:"primary",onClick:()=>A(!0),children:"Customize Order"}),e.jsx(D,{className:"text-end",style:{marginRight:"30px"},children:e.jsxs("h6",{children:["Total: â‚¹",n.totalAmount]})})]}),e.jsx("div",{children:e.jsx(F,{children:e.jsxs(D,{xs:12,md:6,children:[e.jsx(p,{htmlFor:"paymentType",children:o("invoice.payment_type")}),e.jsxs(y,{id:"paymentType",name:"paymentType",value:n.paymentType,onChange:x,children:[e.jsx("option",{value:0,children:o("invoice.cash")}),e.jsx("option",{value:1,children:o("invoice.online")})]})]})})}),e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-sm-2",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(p,{htmlFor:"discount",children:[o("invoice.discount")," (%)"]}),e.jsx(h,{type:"number",id:"discount",placeholder:"0",name:"discount",value:n.discount===0?"":n.discount,onChange:s=>{const t=s.target.value===""?"":Math.max(0,Math.min(100,s.target.value));x({target:{name:"discount",value:t}})}})]})}),e.jsx("div",{className:"col-sm-3",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(p,{htmlFor:"paidAmount",children:[o("invoice.paid_amount")," (Rs)"]}),e.jsx(h,{type:"number",id:"paidAmount",placeholder:"",name:"paidAmount",value:n.paidAmount,onChange:x})]})}),e.jsx("div",{className:"col-sm-3",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(p,{htmlFor:"paidAmount",children:[o("invoice.balance_amount")," (Rs)"]}),e.jsx(h,{type:"number",id:"balanceAmount",placeholder:"",readOnly:!0,name:"balanceAmount",value:n.balanceAmount,onChange:x})]})}),e.jsx("div",{className:"col-sm-2",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(p,{htmlFor:"finalAmount",children:[o("invoice.final_amount")," (Rs)"]}),e.jsx(h,{type:"number",id:"finalAmount",placeholder:"",name:"finalAmount",readOnly:!0,value:n.billedAmount,onChange:x})]})})]}),e.jsx("div",{children:T&&e.jsx(F,{children:e.jsx(L,{color:"danger",children:T})})}),e.jsxs("div",{className:"mb-3 mt-3",children:[e.jsx(j,{color:"success",type:"submit",children:o("invoice.submit")}),"Â ",e.jsx(j,{color:"secondary",onClick:Ce,children:o("invoice.clear")}),"Â ",n.paymentType==1&&e.jsx(j,{className:"mr-20",type:"button",onClick:()=>u(!0),color:"primary",children:o("invoice.view_qr")})]})]})})]})}),e.jsx(De,{visible:K,setVisible:A,onAddProduct:fe})]})};export{ns as default};
